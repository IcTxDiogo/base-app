#!/bin/bash
set -e

APP_USER="sail"
NODE_USER="node"
ARGS=("$@")

show_help() {
    echo "Uso: ./dev <comando> [argumentos]"
    echo ""
    echo "Comandos de GestÃ£o do Ambiente:"
    echo "  up, down, ps, logs, ...  Executa qualquer comando padrÃ£o do Docker Compose (ex: ./dev logs -f app)."
    echo "  reset                    Reseta o ambiente completamente, forÃ§ando uma nova instalaÃ§Ã£o."
    echo ""
    echo "Ferramentas de Desenvolvimento:"
    echo "  artisan [args]           Executa um comando Artisan (ex: ./dev artisan make:model Produto)."
    echo "  composer [args]          Executa um comando Composer (ex: ./dev composer require ...)."
    echo "  npm [args]               Executa um comando NPM (ex: ./dev npm install axios)."
    echo "  php [args]               Executa um comando PHP genÃ©rico no container 'app'."
    echo ""
    echo "Ferramentas de Testes (Pest):"
    echo "  test [pest args]         Roda os testes em PARALELO para mÃ¡xima velocidade."
    echo "  test:watch [pest args]   Roda os testes em modo 'watch', executando novamente a cada alteraÃ§Ã£o."
    echo "  test:coverage [args]     Gera um relatÃ³rio de cobertura de cÃ³digo no terminal (PARALELO)."
    echo "  test:coverage-html [args] Gera um relatÃ³rio de cobertura em HTML (PARALELO) - storage/coverage/index.html."
    echo "  test:debug [args]        Executa testes com Xdebug ativo para debug remoto (PARALELO)."
    echo ""
    echo "Acesso aos Containers:"
    echo "  shell                    Abre um terminal no container 'app' como usuÃ¡rio '$APP_USER'."
    echo "  node-shell               Abre um terminal no container 'node' como usuÃ¡rio '$NODE_USER'."
    echo "  root                     Abre um terminal como 'root' no container 'app' (para tarefas de admin)."
    echo ""
    echo "  help | -h | --help       Mostra esta mensagem de ajuda."
}

case "$1" in
    help|-h|--help)
        show_help
        ;;
    reset)
        echo "ğŸ”„ Resetando e reconstruindo o ambiente completamente..."
        echo "-> Passo 1/3: Removendo flags de instalaÃ§Ã£o..."
        docker compose exec -u $APP_USER app sh -c "rm -f /var/www/html/storage/installed.flag"
        docker compose exec -u $NODE_USER node sh -c "rm -f /var/www/html/node_modules/.installed.flag"
        echo "-> Passo 2/3: Parando e removendo todos os containers..."
        docker compose down
        echo "-> Passo 3/3: Subindo o ambiente e executando a configuraÃ§Ã£o inicial..."
        docker compose up -d --build
        echo ""
        echo "âœ… Ambiente resetado e no ar! A configuraÃ§Ã£o inicial serÃ¡ executada em segundo plano."
        echo "   Use './dev logs -f app' e './dev logs -f node' para acompanhar o processo."
        ;;
    artisan|art)
        shift; echo "Laravel â€º php artisan $@"; docker compose exec -u $APP_USER app php artisan "$@"
        ;;
    composer|comp)
        shift; echo "Composer â€º $@"; docker compose exec -u $APP_USER app composer "$@"
        ;;
    npm)
        shift; echo "NPM â€º $@"; docker compose exec -u $NODE_USER node npm "$@"
        ;;
    php)
        shift; echo "PHP â€º $@"; docker compose exec -u $APP_USER app php "$@"
        ;;
    test)
        shift
        echo "ğŸ§ª Executando testes com Pest (em paralelo)..."
        docker compose exec -u $APP_USER app php artisan test --parallel "$@"
        ;;
    test:watch)
        shift
        PEST_ARGS="$@"

        if ! command -v inotifywait >/dev/null 2>&1; then
            echo "[!] 'inotifywait' nÃ£o encontrado. Para usar o modo 'watch', por favor instale com: sudo apt install inotify-tools"
            exit 1
        fi

        run_tests() {
            clear
            echo "[watch] Executando testes com os argumentos: '$PEST_ARGS'..."
            docker compose exec -u $APP_USER -e COLUMNS=$(tput cols) -T app php artisan test $PEST_ARGS || true
            echo -e "\n[watch] âœ… Testes concluÃ­dos. Aguardando novas alteraÃ§Ãµes... (Ctrl+C para sair)"
        }

        run_tests
        set +e
        while true; do
            inotifywait -r -e modify,create,delete --exclude '(\.git|storage|vendor|\.phpunit\.result\.cache|node_modules)' ./app ./tests >/dev/null 2>&1
            run_tests
        done
        set -e
        ;;
    test:coverage)
        shift
        echo "ğŸ“Š Gerando relatÃ³rio de cobertura para Pest (paralelo)..."
        echo "ğŸ”§ Configurando Xdebug para coverage..."
        docker compose exec -e XDEBUG_MODE=coverage -u $APP_USER app php artisan test --parallel --coverage --min=80 "$@"
        echo "âœ… RelatÃ³rio de cobertura gerado."
        ;;
    test:coverage-html)
        shift
        echo "ğŸ“Š Gerando relatÃ³rio de cobertura HTML (paralelo)..."
        echo "ğŸ”§ Configurando Xdebug para coverage..."
        docker compose exec -e XDEBUG_MODE=coverage -u $APP_USER app php artisan test --parallel --coverage-html=storage/coverage "$@"
        echo "âœ… RelatÃ³rio HTML gerado em storage/coverage/index.html"
        echo "ğŸ’¡ Para visualizar: abra storage/coverage/index.html no navegador"
        ;;
    test:debug)
        shift
        echo "ğŸ› Executando testes com Xdebug ativo para debug (paralelo)..."
        docker compose exec -e XDEBUG_MODE=debug -e XDEBUG_TRIGGER=1 -u $APP_USER app php artisan test --parallel "$@"
        ;;
    shell)
        echo "ğŸ’» Acessando o terminal do container 'app' como usuÃ¡rio '$APP_USER'..."; docker compose exec -u $APP_USER app bash ;;
    node-shell)
        echo "ï¿½ Acessando o terminal do container 'node' como usuÃ¡rio '$NODE_USER'..."; docker compose exec -u $NODE_USER node sh ;;
    root)
        echo "ğŸš¨ Acessando o terminal do container 'app' como usuÃ¡rio 'root'..."; docker compose exec -u root app bash ;;
    *)
        echo "Docker â€º docker compose $@"; docker compose "$@" ;;
esac